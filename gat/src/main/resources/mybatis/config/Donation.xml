<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="donation">
	<!-- 신청서 insert -->
 	<insert id="addApplication" parameterType="applicationPostVO">
 		<selectKey keyProperty="appNo" resultType="string" order="BEFORE">
			select
			application_seq.nextval from dual
		</selectKey>
 		insert into application(
 		app_no, 
 		app_title, 
 		app_summery,
 		app_contents,
 		app_place,
 		app_imgdirectory,
 		goal_mileage,
 		start_date,
 		end_date,
 		app_status, 
 		id)
 		values(#{appNo}, 
 		#{appTitle}, 
 		#{appSummery},
 		#{appContents},
 		#{place},
 		#{imgDirectory},
 		#{goalMileage},
 		#{startDate},
 		#{endDate},
 		'처리중',
 		#{memberVO.id})
 	</insert>
 	<!-- 선물 리스트 입력 -->
 	<insert id="addPresent" parameterType="presentVO">
 		insert into present(present_no, donation_mileage, present_contents, app_no) 
 		values(present_seq.nextval, #{donationMileage}, #{presentContents}, #{appNo})
 	</insert>
 	<!-- 신청서 보기 -->
 	<!-- <select id="readDonationDetail" resultType="donationPostVO">
 		select dp_no, dp_title, dp_contents, dp_regdate, dp_place, dp_count, goal_mileage, donation_mileage, total_entry 
		from donation_post where dp_no=#{value}
 	</select> -->
 	<!-- 재능기부 상세보기 -->
 	<select id="readDonationDetail" resultType="donationPostVO">
 		<!-- 일반 재능기부 게시판 view -->
 		select dp_no, dp_title, dp_contents, dp_regdate, dp_place, dp_count, goal_mileage, donation_mileage, total_entry 
		from donation_post where dp_no=#{value}
 	</select>
 	<!-- 해당 재능기부의 응원메시지 목록 -->
	<select id="readDonationCheerUpMessageList" parameterType="string" resultType="takeDonationPostVO">
 		select td_no, td_regdate, td_mileage, cheerup_message, id, dp_no
		from take_donation
		where dp_no=#{value}
 	</select>
 	<select id="DonationListView" resultType="map" parameterType="donationPostPagingBean">
 		SELECT d.dp_no, d.dp_title, d.dp_summery, d.dp_imgdirectory, d.dp_count, d.dp_status, a.id FROM(
		SELECT row_number() over(order by dp_no desc) as rnum, dp_no, dp_title, 
		dp_summery, dp_imgdirectory, dp_count, dp_status, app_no
		FROM donation_post
		) d ,application a where d.app_no=a.app_no and rnum between #{startRowNumber} and #{endRowNumber} 
		order by dp_no desc
 	</select>
 	
 	<!-- 해당 재능기부 후기 수-->
 	<select id="totalDonationReviewCount" parameterType="string" resultType="int">
 		select count(*) from review_post where dp_no=#{values}
 	</select>
 	
 	<!-- 해당 재능기부 후기 목록 --> 	
 	<resultMap type="ReviewPostVO" id="memberRM">
 		<result column="id"  property="memberVO.id"/>
 		<result column="name"  property="memberVO.name"/>
 	</resultMap> 
 	<select id="readDonationReviewList" resultType="ReviewPostVO" resultMap="memberRM">
 		select rp_no, rp_title, rp_contents, rp_regdate, rp_rate, rp.id, m.id, m.name
		from review_post rp, gt_member m
		where rp.id=m.id and dp_no=#{value}
		order by rp_no desc
 	</select>
 	<!-- <select id="readDonationReviewList" parameterType="ReviewPostPagingBean" resultType="ReviewPostVO">
 		select rp_no, rp_title, rp_contents, rp_regdate, rp_rate, id, dp_no, td_no from
 		(SELECT row_number() over(order by rp_no desc) AS rnum, 
 		t.rp_title, t.rp_contents, to_char(t.rp_regdate,'YYYY.MM.DD') as rp_regdate, 
 		t.rp_rate, mug.mug_name, t.id from MILEAGE_TRADE t
		inner join MILEAGE_USE_GROUP mug on mug.mug_no=t.mug_no
		inner join GT_MEMBER m on t.id = m.id
		and m.id=#{id}) where rnum between #{startRowNumber} and #{endRowNumber} order by mtNo desc
 	</select> -->
 	<!-- 재능기부 모금마일리지, 총 참여자 수 -->
 	<update id="updateDonationMileage" parameterType="takeDonationPostVO">
 		update donation_post set donation_mileage=donation_mileage+#{tdMileage}, total_entry=total_entry+1
 		where dp_no=#{donationPostVO.dpNo}
 	</update>
 	
 	<!-- 재능기부 스크롤 페이징 게시판 -->
 	<select id="DonationListView2" resultType="map">
		SELECT row_number() over(order by dp_no desc) as rnum, dp_no, dp_title, 
		dp_summery, dp_imgdirectory, dp_count, dp_status, app_no
		FROM donation_post
 	</select>
 	
 	<!-- 재능기부 리스트 상위 3명  -->
 	<select id="DonationListRank" resultType="map">
		<![CDATA[select d.dp_no, total_entry, d.dp_title, d.dp_summery, d.dp_imgdirectory, d.dp_count, d.dp_status, d.app_no
		from(
		select  RANK() OVER (ORDER BY total_entry desc) as rank, dp_no,total_entry, dp_title, dp_summery, dp_imgdirectory, dp_count, dp_status, app_no
		from donation_post
		) d where rank <=3
		]]>
 	</select>
</mapper>
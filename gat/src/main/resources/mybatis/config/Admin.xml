<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="admin">
	<select id="totalUnReceivedApplicationCount" resultType="int">
		select
		count(*) from application where app_status='처리중'
	</select>
	
	<resultMap type="applicationPostVO" id="appPostVO">
		<result column="app_no" property="appNo"/>
		<result column="app_title" property="appTitle"/>
		<result column="app_contents" property="appContents"/>
		<result column="app_place" property="place"/>
		<result column="app_regdate" property="appRegdate"/>
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
		<result column="goal_mileage" property="goalMileage"/>
		<result column="app_status" property="appStatus"/>
		<collection property="presentList" ofType="presentVO" 
		javaType="java.util.List" column="app_no" select="selectPresent"></collection>
		<collection property="memberVO" javaType="memberVO" column="app_no"
		select="selectMember"></collection>
	</resultMap>
	
	<select id="selectPresent" resultType="presentVO" parameterType="string">
		select pre.present_no,pre.donation_mileage,pre.present_contents
		from present pre, application app
		where pre.app_no=app.app_no and pre.app_no=#{value}
	</select>
	
	<select id="selectMember" resultType="memberVO" parameterType="string">
		select m.id,m.password,m.name,m.address,m.birthday,m.mileage,m.total_use_mileage
		from gt_member m, application app
		where m.id=app.id and app.app_no=#{value}
	</select>
	
	<select id="readUnReceivedApplicationList"
		resultMap="appPostVO" parameterType="applicationPostPagingBean">
		<![CDATA[
 			select rnum,app.app_no,app.app_title,app.app_place,app.app_regdate,
 			app.start_date,app.end_date,app.goal_mileage,app.app_status
			from (select row_number() over(order by app_no desc) rnum,app_no,app_title,
			app_place,to_char(app_regdate,'yyyy.mm.dd') app_regdate,
			to_char(start_date,'yyyy.mm.dd') start_date,
			to_char(end_date,'yyyy.mm.dd') end_date,goal_mileage,app_status,id
			from application) app, gt_member m
			where app.id=m.id and app.app_status='처리중' and rnum between #{startRowNumber} 
			and #{endRowNumber} order by app.app_no desc
 		]]>
	</select>
	
	<select id="readUnReceivedApplicationDetail" resultMap="appPostVO">
		<![CDATA[
			select app.app_no,app.app_title,app.app_contents,app.app_place,
			to_char(app.app_regdate,'yyyy.mm.dd') app_regdate,
			to_char(app.start_date,'yyyy.mm.dd') start_date,
			to_char(app.end_date,'yyyy.mm.dd') end_date,
			app.goal_mileage,app.app_status
			from application app, gt_member m
			where m.id=app.id and app.app_no=#{value}
		]]>
	</select>
	
	<update id="rejectionApplication">
		update application set app_status='거절' where app_no=#{value}
	</update>
	
	<update id="approvalApplication">
		update application set app_status='승인' where app_no=#{value}
	</update>
	
	<insert id="addApplicationAnswer" parameterType="applicationPostVO">
		insert into application(app_no,app_title,app_contents,
		app_status,app_parent_no,id,ag_no)
		values(application_seq.nextval,#{appTitle},#{appContents},
		'답변완료',#{appNo},#{memberVO.id},'3')
	</insert>
	
	<insert id="addDonationPost" parameterType="applicationPostVO">
		insert into donation_post(dp_no,dp_title,dp_contents,dp_place,goal_mileage,app_no)
		values(donation_post_seq.nextval,#{appTitle},#{appContents},#{place},#{goalMileage},#{appNo})
	</insert>
</mapper>